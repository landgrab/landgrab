<% mentioned_tiles = post.mentioned_tiles %>
<% project = post.post_associations.where(postable_type: 'Project').first&.postable %>
<% plots = post.post_associations.where(postable_type: 'Plot').map(&:postable) %>
<% linked_tiles = post.post_associations.where(postable_type: 'Tile').map(&:postable) %>
<% user_subscribed_tiles = current_user&.associated_subscriptions&.select(&:usable_stripe_status?) %>

<% if mentioned_tiles.any? || linked_tiles.any? %>
  <p>
    <% if mentioned_tiles.any? && (linked_tiles - mentioned_tiles).any? %>
      This post mentions
      <%= pluralize(mentioned_tiles.size, 'tile') %>
      and is associated with
      <%= pluralize((linked_tiles - mentioned_tiles).size, 'additional tile') %>,
      shown on the map below.
    <% elsif mentioned_tiles.any? %>
      This post mentions
      <%= pluralize(mentioned_tiles.size, 'tile') %>,
      shown on the map below.
    <% elsif linked_tiles.any? %>
      This post is associated with
      <%= pluralize(linked_tiles.size, 'tile') %>,
      shown on the map below.
    <% end %>
  </p>
  <%= render 'static_pages/w3w_map',
    tiles: linked_tiles + mentioned_tiles,
    plot: plots.first,
    popup_tiles: mentioned_tiles,
    tile_legend: [
      { key: 'My Tile', tiles: user_subscribed_tiles, colour: 'gold' },
      { key: 'Mentioned Tile', tiles: linked_tiles + mentioned_tiles, colour: 'green' }
    ] %>
<% end %>
